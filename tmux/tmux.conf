# ============================================
# PLUGINS
# ============================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tardunge/tmux-gh'
set -g @plugin 'jaclu/tmux-menus'
set -g @plugin 'rose-pine/tmux'

# ============================================
# TERMINAL & DISPLAY
# ============================================
set -g default-terminal "tmux-256color"
set-option -sa terminal-features ',xterm-256color:RGB'
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -g focus-events on
set-option -g status-interval 5
set-option -g repeat-time 0

# ============================================
# ENVIRONMENT
# ============================================
# Propagate Wayland env vars into tmux sessions so GUI apps
# (like VS Code) launched from tmux use native Wayland
set -ga update-environment " WAYLAND_DISPLAY"

# Track SSH client IP for session persistence
set -ga update-environment " TMUX_SSH_IP"

# ============================================
# SSH SESSION TRACKING
# ============================================
# Update last-session tracker when switching sessions (for SSH reconnect)
set-hook -g client-session-changed 'run-shell -b "if [ -n \"$TMUX_SSH_IP\" ]; then mkdir -p $HOME/.tmux-sessions && echo #{session_name} > $HOME/.tmux-sessions/$TMUX_SSH_IP; fi"'

# ============================================
# BEHAVIOR
# ============================================
# Mouse support
set -g mouse on

# Start indexing from 1 instead of 0
set -g base-index 1
setw -g pane-base-index 1

# Reorder window numbers on delete
set-option -g renumber-windows on

# No delay for escape key
set -s escape-time 0

# Set terminal title
set -g set-titles on

# Display times
set -g display-panes-time 800
set -g display-time 5000

# Large history limit
set -g history-limit 5000000

# Activity monitoring
set -g monitor-activity on
set -g visual-activity off

# Auto-rename windows based on current directory
set -g automatic-rename-format '#(basename "#{pane_current_path}")'

# ============================================
# KEYBINDINGS
# ============================================
# Window navigation (use p/n or prefix+number)
unbind .
unbind ,
bind , previous-window
bind . next-window
# Resizing
bind -n S-Left  resize-pane -L 5
bind -n S-Right resize-pane -R 5
bind -n S-Up    resize-pane -U 5
bind -n S-Down  resize-pane -D 5




# New window in current path
bind c new-window -c "#{pane_current_path}"

# Split panes in current path
bind '_' split-window -c "#{pane_current_path}"
bind '|' split-window -h -c "#{pane_current_path}"

# Triple split layout (vertical)
bind F split-window -c "#{pane_current_path}" \; split-window -c "#{pane_current_path}" \; select-layout even-vertical

# Kill pane and window
unbind x
bind x kill-pane
unbind X
bind X kill-window

# Kill session in choose-session mode
bind -T choose-session X kill-session

# ============================================
# COPY MODE (Vi-style)
# ============================================
# Enable vi mode
setw -g mode-keys vi

# Quick search in scrollback (Prefix + /)
bind / copy-mode \; send-keys ?

# Vi-style visual selection and yank
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "wl-copy"

# Vi-style search in copy mode
bind -T copy-mode-vi / command-prompt -i -p "(search down)" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "(search up)" "send -X search-backward-incremental \"%%%\""

# Mouse drag to copy
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "wl-copy"

# ============================================
# STATUS BAR
# ============================================
set -g status-left-length 50

# ============================================
# THEME (Rose Pine)
# ============================================
set -g @rose_pine_variant 'main'
set -g @rose_pine_host ''
set -g @rose_pine_date_time ''
set -g @rose_pine_user ''
set -g @rose_pine_directory ''

# Pane borders
set -g pane-border-lines "heavy"

# ============================================
# PLUGIN MANAGER INIT (must be at bottom)
# ============================================
run '~/.config/tmux/plugins/tpm/tpm'

# Override theme's status-right after TPM loads
set -g status-right-length 100
set -g status-right " #(~/Documents/projects/personal/.dotfiles/tmux/scripts/claude-usage.sh) "
